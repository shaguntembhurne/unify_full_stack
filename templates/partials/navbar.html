<header class="p-4 bg-[#FDE68A]/80 backdrop-blur-sm">
  <div class="max-w-7xl mx-auto flex justify-between items-center neubrutalism rounded-lg px-4 py-3">
    <a href="/" class="text-2xl font-bold">Unify Hub</a>
    <nav class="hidden md:flex items-center space-x-6 font-medium">
      <a href="/news/" class="hover:underline">News</a>
  <a href="/projects/" class="hover:underline">Projects</a>
      <a href="#how-it-works" class="hover:underline">How It Works</a>
    </nav>
    <div class="flex items-center gap-3">
      {% if user.is_authenticated %}
        <div class="relative" id="notif-wrapper">
          <button id="notif-bell" class="relative btn-neubrutalism p-2 rounded-md" title="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75V9a6 6 0 10-12 0v.75a8.967 8.967 0 01-2.312 6.022c1.766.68 3.585 1.134 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
            </svg>
            <span id="notif-dot" class="hidden absolute -top-1 -right-1 h-3 w-3 bg-red-500 rounded-full border-2 border-black"></span>
          </button>
          <div id="notif-dropdown" class="hidden absolute right-0 mt-2 w-80 neubrutalism rounded-lg p-2 z-50 bg-white">
            <div id="notif-list" class="max-h-80 overflow-y-auto divide-y-2 divide-black"></div>
            <div class="p-2 text-center text-xs text-gray-600">No notifications</div>
          </div>
        </div>
        <a href="/profile/" class="btn-neubrutalism px-4 py-2 font-semibold">Profile</a>
      {% else %}
        <a href="/auth/" class="btn-neubrutalism px-4 py-2 font-semibold">Login</a>
        <a href="/auth/" class="btn-neubrutalism px-4 py-2 font-semibold bg-[#8B5CF6] text-white">Sign Up</a>
      {% endif %}
    </div>
  </div>
</header>
<script>
  (function(){
    const bell = document.getElementById('notif-bell');
    const dot = document.getElementById('notif-dot');
    const dd = document.getElementById('notif-dropdown');
    const list = document.getElementById('notif-list');
    if (!bell) return;
    let openedOnce = false;
    function fetchNotifications(){
      fetch('/notifications/dropdown/', {credentials:'same-origin'})
        .then(r=>r.ok?r.json():Promise.reject())
        .then(({items, unseen})=>{
          dot.classList.toggle('hidden', !(unseen && unseen>0));
          list.innerHTML = '';
          if (!items || items.length===0){
            dd.querySelector('div.p-2')?.classList.remove('hidden');
            return;
          }
          dd.querySelector('div.p-2')?.classList.add('hidden');
          items.forEach(n=>{
            const color = n.is_read ? 'bg-white' : 'bg-yellow-100';
            const row = document.createElement('div');
            row.className = `p-3 ${color}`;
            row.innerHTML = `<div class="text-sm font-semibold">${n.message}</div>
                             <div class="text-xs text-gray-600 mt-1">${new Date(n.created_at).toLocaleString()}</div>`;
            list.appendChild(row);
          });
        }).catch(()=>{});
    }
    function csrf(){
      const name='csrftoken='; for(let c of document.cookie.split(';')){ c=c.trim(); if(c.startsWith(name)) return c.substring(name.length);} return '';
    }
    bell.addEventListener('click', ()=>{
      dd.classList.toggle('hidden');
      if (!openedOnce){ fetchNotifications(); openedOnce=true; }
      // Mark as read on open
      fetch('/notifications/mark-read/', { method:'POST', headers:{'X-CSRFToken': csrf()}, credentials:'same-origin'})
        .then(()=>fetchNotifications());
    });
    // Optionally poll every 60s
    setInterval(fetchNotifications, 60000);
    // initial minimal fetch to show dot state
    fetchNotifications();
    document.addEventListener('click', (e)=>{
      const wrap = document.getElementById('notif-wrapper');
      if (wrap && !wrap.contains(e.target)) dd.classList.add('hidden');
    });
  })();
</script>